<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enregistreur Audio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

</head>

<body class="p-3 bg-light">
    <div class="container" style="max-width: 800px;">
        <div class="card mt-5">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Enregistreur Audio</h3>
            </div>
            <div class="card-body">

                <div class="d-flex gap-2 align-items-center mb-3">
                    <button id="btn-demarrer" class="btn btn-success">
                        Démarrer l'enregistrement
                    </button>

                    <button id="btn-stop" class="btn btn-danger" disabled>
                        Arrêter
                    </button>
                </div>

                <div id="timer" class="fs-4 fw-bold text-danger mt-2" style="display: none;">00:00</div>

                <div id="status" class="mt-2">
                    <span class="badge bg-secondary">Prêt à enregistrer</span>
                </div>

                <div id="audio-container" class="d-none">
                    <hr>
                    <h5>Enregistrement :</h5>
                    <audio id="audio-player" controls class="w-100 mt-3"></audio>
                    <div class="mt-2">
                        <a id="btn-telecharger" class="btn btn-primary btn-sm" download="enregistrement.wav">
                            Télécharger
                        </a>
                        <button id="btn-nouveau" class="btn btn-secondary btn-sm">
                            Nouvel enregistrement
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-danger mt-3 d-none" id="alert-erreur">
            <strong>Erreur !</strong> <span id="message-erreur"></span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const btnDemarrer = document.getElementById('btn-demarrer');
        const btnStop = document.getElementById('btn-stop');
        const btnTelecharger = document.getElementById('btn-telecharger');
        const btnNouveau = document.getElementById('btn-nouveau');
        const audioPlayer = document.getElementById('audio-player');
        const audioContainer = document.getElementById('audio-container');
        const status = document.getElementById('status');
        const timer = document.getElementById('timer');
        const alertErreur = document.getElementById('alert-erreur');
        const messageErreur = document.getElementById('message-erreur');

        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let seconds = 0;

        // Fonction pour formater le temps
        function formatTime(sec) {
            const minutes = Math.floor(sec / 60);
            const secs = sec % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Démarrer l'enregistrement
        btnDemarrer.addEventListener('click', async function () {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                seconds = 0;

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    btnTelecharger.href = audioUrl;
                    audioContainer.classList.remove('d-none');

                    // Arrêter toutes les pistes audio
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                // Mise à jour de l'interface
                btnDemarrer.disabled = true;
                btnStop.disabled = false;
                timer.classList.remove('d-none');
                audioContainer.classList.add('d-none');
                status.innerHTML = '<span class="badge bg-danger">Enregistrement en cours...</span>';
                alertErreur.classList.add('d-none');

                // Démarrer le timer
                timerInterval = setInterval(() => {
                    seconds++;
                    timer.textContent = formatTime(seconds);
                }, 1000);

            } catch (error) {
                console.error('Erreur d\'accès au microphone:', error);
                messageErreur.textContent = 'Impossible d\'accéder au microphone. Vérifiez les permissions.';
                alertErreur.classList.remove('d-none');
            }
        });

        // Arrêter l'enregistrement
        btnStop.addEventListener('click', function () {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(timerInterval);

                btnDemarrer.disabled = false;
                btnStop.disabled = true;
                timer.classList.add('d-none');
                status.innerHTML = '<span class="badge bg-success">✓ Enregistrement terminé</span>';
            }
        });

        // Nouvel enregistrement
        btnNouveau.addEventListener('click', function () {
            audioContainer.classList.add('d-none');
            timer.textContent = '00:00';
            seconds = 0;
            status.innerHTML = '<span class="badge bg-secondary">Prêt à enregistrer</span>';
        });
    </script>
</body>

</html>