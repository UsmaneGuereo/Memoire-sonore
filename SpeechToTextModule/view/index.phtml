<?php
/**
 * Vue pour l'enregistrement audio
 * Fichier: view/audio-recorder/index/record.phtml
 */

$this->headLink()->appendStylesheet($this->assetUrl('css/audio-recorder.css', 'AudioRecorder'));
$this->headScript()->appendFile($this->assetUrl('js/audio-recorder.js', 'AudioRecorder'));
?>

<div class="audio-recorder-container">
    <h2><?php echo $this->translate('Enregistrer un audio'); ?></h2>
    
    <div class="recorder-section">
        <div class="recorder-controls">
            <button id="startRecord" class="button">
                <i class="fa fa-microphone"></i> <?php echo $this->translate('Démarrer'); ?>
            </button>
            <button id="stopRecord" class="button" disabled>
                <i class="fa fa-stop"></i> <?php echo $this->translate('Arrêter'); ?>
            </button>
            <button id="playRecord" class="button" disabled>
                <i class="fa fa-play"></i> <?php echo $this->translate('Écouter'); ?>
            </button>
        </div>
        
        <div class="recording-status">
            <span id="recordingTime">00:00</span>
            <span id="recordingIndicator" class="indicator"></span>
        </div>
        
        <div class="audio-preview">
            <audio id="audioPlayback" controls style="display:none;"></audio>
        </div>
    </div>
    
    <div class="audio-form-section" id="formSection" style="display:none;">
        <?php echo $this->form()->openTag($form); ?>
        
        <div class="field">
            <?php echo $this->formLabel($form->get('title')); ?>
            <?php echo $this->formElement($form->get('title')); ?>
            <?php echo $this->formElementErrors($form->get('title')); ?>
        </div>
        
        <div class="field">
            <?php echo $this->formLabel($form->get('description')); ?>
            <?php echo $this->formElement($form->get('description')); ?>
            <?php echo $this->formElementErrors($form->get('description')); ?>
        </div>
        
        <div class="field">
            <?php echo $this->formLabel($form->get('item_id')); ?>
            <?php echo $this->formElement($form->get('item_id')); ?>
            <p class="field-meta"><?php echo $this->translate('Item Omeka auquel associer cet audio'); ?></p>
        </div>
        
        <input type="hidden" id="audioData" name="audio_data" value="">
        
        <div class="form-actions">
            <button type="submit" class="button submit-button">
                <?php echo $this->translate('Enregistrer'); ?>
            </button>
            <a href="<?php echo $this->url('admin/audio-recorder'); ?>" class="button">
                <?php echo $this->translate('Annuler'); ?>
            </a>
        </div>
        
        <?php echo $this->form()->closeTag(); ?>
    </div>
</div>

<script>
// JavaScript pour l'enregistrement audio
let mediaRecorder;
let audioChunks = [];
let recordingStartTime;
let timerInterval;

document.getElementById('startRecord').addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audioPlayback = document.getElementById('audioPlayback');
            audioPlayback.src = audioUrl;
            audioPlayback.style.display = 'block';
            
            // Convertir en base64 pour l'envoi
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                document.getElementById('audioData').value = reader.result;
                document.getElementById('formSection').style.display = 'block';
            };
            
            document.getElementById('playRecord').disabled = false;
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        startTimer();
        
        document.getElementById('startRecord').disabled = true;
        document.getElementById('stopRecord').disabled = false;
        document.getElementById('recordingIndicator').classList.add('recording');
        
    } catch (err) {
        alert('Erreur: impossible d\'accéder au microphone. ' + err.message);
    }
});

document.getElementById('stopRecord').addEventListener('click', () => {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
    stopTimer();
    
    document.getElementById('startRecord').disabled = false;
    document.getElementById('stopRecord').disabled = true;
    document.getElementById('recordingIndicator').classList.remove('recording');
});

document.getElementById('playRecord').addEventListener('click', () => {
    const audio = document.getElementById('audioPlayback');
    if (audio.paused) {
        audio.play();
    } else {
        audio.pause();
    }
});

function startTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Date.now() - recordingStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('recordingTime').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}
</script>

<style>
.audio-recorder-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
}

.recorder-section {
    background: #f5f5f5;
    padding: 30px;
    border-radius: 8px;
    margin-bottom: 30px;
    text-align: center;
}

.recorder-controls {
    margin-bottom: 20px;
}

.recorder-controls button {
    margin: 0 5px;
    padding: 12px 24px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: #0066cc;
    color: white;
}

.recorder-controls button:disabled {
    background: #cccccc;
    cursor: not-allowed;
}

.recorder-controls button:not(:disabled):hover {
    background: #0052a3;
}

.recording-status {
    font-size: 24px;
    margin: 20px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #ccc;
}

.indicator.recording {
    background: #ff0000;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.audio-preview {
    margin-top: 20px;
}

.audio-preview audio {
    width: 100%;
    max-width: 500px;
}

.audio-form-section {
    background: white;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.field {
    margin-bottom: 20px;
}

.field label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.field input[type="text"],
.field textarea,
.field select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.field textarea {
    min-height: 100px;
}

.field-meta {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.form-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

.submit-button {
    background: #28a745 !important;
}

.submit-button:hover {
    background: #218838 !important;
}
</style>